<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suggestion - Prompt Admin</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    h1 { color: #333; margin: 0 0 10px 0; }
    .subtitle { color: #666; margin-bottom: 20px; }
    .nav-links {
      margin-bottom: 20px;
      padding: 10px;
      background: #e9ecef;
      border-radius: 4px;
    }
    .nav-links a {
      margin-right: 15px;
      color: #007bff;
      text-decoration: none;
    }
    .nav-links a:hover { text-decoration: underline; }
    .section { margin-bottom: 25px; }
    textarea {
      width: 100%;
      height: 300px;
      padding: 12px;
      font-size: 14px;
      font-family: monospace;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
    }
    button {
      padding: 10px 20px;
      font-size: 14px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button.reset-btn { background: #6c757d; }
    button.reset-btn:hover { background: #5a6268; }
    .status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .status.success { display: block; background: #d4edda; color: #155724; }
    .status.error { display: block; background: #f8d7da; color: #721c24; }
    .card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .model-info {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    .model-info select {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-width: 150px;
    }
    .model-info label {
      font-weight: 500;
      margin-right: 5px;
    }
    .preview-card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .preview-card h3 {
      margin-top: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .preview-content {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 12px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 400px;
      overflow-y: auto;
    }
    button.preview-btn {
      background: #28a745;
    }
    button.preview-btn:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Suggestion Prompt</h1>
    <p class="subtitle">Configure the AI prompt for consultation/suggestion responses</p>

    <div class="nav-links">
      <a href="/admin.html">Main Admin</a>
      <a href="/admin-analyze-intent.html">Analyze Intent</a>
      <a href="/admin-generate-direction.html">Generate Direction</a>
      <a href="/admin-grade-own.html">Grade Own Message</a>
      <a href="/admin-suggestion.html">Suggestion</a>
      <a href="/admin-generate-response.html">Generate Response</a>
    </div>

    <div class="card">
      <div class="model-info">
        <div>
          <label for="llm-provider">Provider:</label>
          <select id="llm-provider"></select>
        </div>
        <div>
          <label for="llm-model">Model:</label>
          <select id="llm-model"></select>
        </div>
        <span id="model-price" style="color: #666;"></span>
      </div>
    </div>

    <div class="card">
      <div class="section">
        <h3>Prompt Template</h3>
        <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
          Full prompt template sent to the LLM. Available placeholders:<br>
          <code>{{conversationHistory}}</code> - The conversation history<br>
          <code>{{selectedMessageInstruction}}</code> - Instructions based on selected message<br>
          <code>{{questionInstruction}}</code> - The user's question if provided
        </p>
        <textarea id="format-textarea" placeholder="Loading..." style="height: 400px;"></textarea>
        <br><br>
        <button id="save-format-btn">Save Template</button>
        <button id="reset-format-btn" class="reset-btn">Reset to Default</button>
        <div id="format-status" class="status"></div>
      </div>
    </div>

    <div class="preview-card">
      <h3>
        <span>Latest Full Prompt</span>
        <button id="preview-btn" class="preview-btn">Refresh</button>
      </h3>
      <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
        Shows the last prompt sent to the LLM when /api/suggestion was called
      </p>
      <div id="preview-meta" style="font-size: 12px; color: #888; margin-bottom: 10px;"></div>
      <div id="preview-content" class="preview-content">
        Loading...
      </div>
      <h4 style="margin-top: 15px;">LLM Output</h4>
      <div id="preview-output" class="preview-content" style="background: #0d2137; color: #7ec8e3;">
        No output yet
      </div>
    </div>
  </div>

  <script>
    const llmProviderEl = document.getElementById('llm-provider');
    const llmModelEl = document.getElementById('llm-model');
    const modelPriceEl = document.getElementById('model-price');

    const formatTextarea = document.getElementById('format-textarea');
    const saveFormatBtn = document.getElementById('save-format-btn');
    const resetFormatBtn = document.getElementById('reset-format-btn');
    const formatStatusEl = document.getElementById('format-status');

    let providersData = [];

    async function loadModels() {
      try {
        const res = await fetch('/api/models');
        providersData = await res.json();
        populateProviders();
      } catch (err) {
        console.error('Failed to load models:', err);
      }
    }

    function populateProviders() {
      llmProviderEl.innerHTML = '';
      providersData.forEach(provider => {
        const option = document.createElement('option');
        option.value = provider.id;
        option.textContent = provider.name;
        llmProviderEl.appendChild(option);
      });
    }

    function populateModelsForProvider(providerId) {
      const provider = providersData.find(p => p.id === providerId);
      llmModelEl.innerHTML = '';
      if (provider) {
        provider.models.forEach(model => {
          const option = document.createElement('option');
          option.value = model.id;
          option.textContent = model.id;
          llmModelEl.appendChild(option);
        });
      }
      updatePriceDisplay();
    }

    function updatePriceDisplay() {
      const provider = providersData.find(p => p.id === llmProviderEl.value);
      const model = provider?.models.find(m => m.id === llmModelEl.value);
      if (model?.input_price) {
        modelPriceEl.textContent = `$${model.input_price}/1M tokens`;
      } else {
        modelPriceEl.textContent = '';
      }
    }

    async function loadLlmSettings() {
      try {
        const [providerRes, modelRes] = await Promise.all([
          fetch('/api/llm-provider'),
          fetch('/api/llm-model')
        ]);
        const providerData = await providerRes.json();
        const modelData = await modelRes.json();

        llmProviderEl.value = providerData.provider || 'openai';
        populateModelsForProvider(llmProviderEl.value);
        llmModelEl.value = modelData.modelName || 'gpt-4o';
        updatePriceDisplay();
      } catch (err) {
        console.error('Failed to load LLM settings:', err);
      }
    }

    // Template functions
    async function loadFormat() {
      try {
        const res = await fetch('/api/suggestion-message-format');
        const data = await res.json();
        formatTextarea.value = data.format || '';
      } catch (err) {
        console.error('Failed to load format:', err);
        formatTextarea.placeholder = 'Failed to load format';
      }
    }

    async function saveFormat() {
      saveFormatBtn.disabled = true;
      saveFormatBtn.textContent = 'Saving...';
      formatStatusEl.className = 'status';

      try {
        const res = await fetch('/api/suggestion-message-format', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ format: formatTextarea.value })
        });

        if (res.ok) {
          formatStatusEl.textContent = 'Template saved successfully!';
          formatStatusEl.className = 'status success';
        } else {
          const data = await res.json();
          formatStatusEl.textContent = 'Error: ' + (data.error || 'Unknown error');
          formatStatusEl.className = 'status error';
        }
      } catch (err) {
        console.error('Failed to save template:', err);
        formatStatusEl.textContent = 'Failed to save template';
        formatStatusEl.className = 'status error';
      } finally {
        saveFormatBtn.disabled = false;
        saveFormatBtn.textContent = 'Save Template';
      }
    }

    async function resetFormat() {
      if (!confirm('Reset to default template? This will discard your changes.')) {
        return;
      }

      formatTextarea.value = `Bạn là chuyên gia về tán tỉnh và tâm lý phụ nữ. Nhiệm vụ của bạn là tư vấn cho người dùng về tâm lý của đối phương trong câu chuyện dựa trên ngữ cảnh được chọn, cách đối phương nhìn nhận người dùng dựa trên ngữ cảnh, và cách đạt được mục tiêu hẹn hò mà người dùng đề ra. Tính cách của bạn là thẳng thắn, hài hước, và hơi châm biếm. Bạn sẽ trả lời ngắn gọn, đi thẳng vào vấn đề, không đi vào chi tiết quá nhiều trừ khi được yêu cầu, và thành thật với người dùng về tình hình thực tế thay vì nịnh nọt cảm xúc của họ.
---
{{conversationHistory}}
---
{{selectedMessageInstruction}}{{questionInstruction}}

Câu trả lời của bạn không được vượt quá 4 câu hoặc 1000 ký tự.`;

      await saveFormat();
    }

    const previewBtn = document.getElementById('preview-btn');
    const previewContentEl = document.getElementById('preview-content');
    const previewMetaEl = document.getElementById('preview-meta');
    const previewOutputEl = document.getElementById('preview-output');

    async function loadLatestPrompt() {
      previewContentEl.textContent = 'Loading...';
      previewOutputEl.textContent = 'Loading...';
      previewMetaEl.textContent = '';

      try {
        const res = await fetch('/api/latest-suggestion-prompt');
        const data = await res.json();

        if (data.prompt) {
          previewContentEl.textContent = data.prompt;
          const date = new Date(data.timestamp).toLocaleString();
          let metaText = `Last called: ${date}`;
          if (data.selectedMessage) {
            metaText += ` | Selected: "${data.selectedMessage}"`;
          }
          if (data.question) {
            metaText += ` | Question: "${data.question}"`;
          }
          if (data.provider) {
            metaText += ` | Provider: ${data.provider}`;
          }
          previewMetaEl.textContent = metaText;
          previewOutputEl.textContent = data.output || 'No output recorded';
        } else {
          previewContentEl.textContent = data.message || 'No prompt stored yet. Call the /api/suggestion endpoint first.';
          previewOutputEl.textContent = 'No output yet';
        }
      } catch (err) {
        console.error('Failed to load latest prompt:', err);
        previewContentEl.textContent = 'Failed to load prompt';
        previewOutputEl.textContent = 'Failed to load output';
      }
    }

    llmProviderEl.addEventListener('change', () => {
      populateModelsForProvider(llmProviderEl.value);
    });
    llmModelEl.addEventListener('change', updatePriceDisplay);
    saveFormatBtn.addEventListener('click', saveFormat);
    resetFormatBtn.addEventListener('click', resetFormat);
    previewBtn.addEventListener('click', loadLatestPrompt);

    // Initial load
    loadModels().then(() => loadLlmSettings());
    loadFormat();
    loadLatestPrompt();
  </script>
</body>
</html>
