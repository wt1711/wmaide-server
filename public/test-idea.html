<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test: Generate Response with Idea</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .panel {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
    }
    .full-width {
      grid-column: 1 / -1;
    }
    h1 {
      color: #333;
      margin: 0 0 10px 0;
      font-size: 24px;
    }
    h2 {
      color: #555;
      margin: 0 0 15px 0;
      font-size: 18px;
    }
    h3 {
      color: #666;
      margin: 0 0 10px 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .subtitle {
      color: #888;
      font-size: 14px;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #444;
    }
    textarea {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      font-family: monospace;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover { background: #5a6268; }
    button.success {
      background: #28a745;
    }
    button.success:hover { background: #218838; }
    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .message-item {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: flex-start;
    }
    .message-item select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-width: 80px;
    }
    .message-item input {
      flex: 1;
    }
    .message-item button {
      padding: 8px 12px;
      background: #dc3545;
    }
    .message-item button:hover { background: #c82333; }
    .add-message-btn {
      background: #17a2b8;
      padding: 8px 16px;
    }
    .add-message-btn:hover { background: #138496; }
    .idea-input {
      background: #fff3cd;
      border: 2px solid #ffc107;
    }
    .idea-input:focus {
      outline: none;
      border-color: #e0a800;
      box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.25);
    }
    .response-box {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 4px;
      font-size: 16px;
      line-height: 1.6;
      min-height: 100px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .response-box.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .response-box.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .meta-item {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      text-align: center;
    }
    .meta-item .label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      margin-bottom: 5px;
    }
    .meta-item .value {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    .meta-item .value.credits {
      color: #28a745;
    }
    .config-row {
      display: flex;
      gap: 15px;
      align-items: flex-end;
      flex-wrap: wrap;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    .config-row > div {
      min-width: 150px;
    }
    .config-row select {
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      min-width: 180px;
    }
    .hint {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .stream-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #28a745;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="panel full-width">
      <h1>Generate Response with Idea</h1>
      <p class="subtitle">Test the /api/generate-response-with-idea endpoint</p>

      <div class="config-row">
        <div>
          <label>Provider</label>
          <select id="provider-select"></select>
        </div>
        <div>
          <label>Model</label>
          <select id="model-select"></select>
        </div>
        <div>
          <label>Price / 1M tokens</label>
          <span id="price-display" style="display: inline-block; padding: 10px; background: #e9ecef; border-radius: 4px; min-width: 80px;">-</span>
        </div>
        <div>
          <label>User ID (optional)</label>
          <input type="text" id="user-id" placeholder="e.g., user123">
        </div>
      </div>
    </div>

    <!-- Left: Input -->
    <div class="panel">
      <h2>Conversation Context</h2>

      <div id="messages-container">
        <!-- Messages will be added here -->
      </div>

      <button class="add-message-btn" onclick="addMessage()">+ Add Message</button>

      <div style="margin-top: 20px;">
        <label>Message to Reply To</label>
        <input type="text" id="reply-message" placeholder="Her last message that you need to reply to...">
      </div>

      <div style="margin-top: 20px;">
        <label style="color: #856404; font-weight: 600;">Your Idea to Incorporate</label>
        <input type="text" id="idea-input" class="idea-input" placeholder="e.g., mention that I also love hiking...">
        <p class="hint">This idea will be naturally woven into the generated response</p>
      </div>

      <div class="button-row">
        <button class="success" id="generate-btn" onclick="generateResponse()">
          Generate Response
        </button>
        <button class="secondary" onclick="loadSampleData()">Load Sample</button>
        <button class="secondary" onclick="clearAll()">Clear All</button>
      </div>
    </div>

    <!-- Right: Output -->
    <div class="panel">
      <h2>Generated Response</h2>

      <div id="response-box" class="response-box">
        Response will appear here...
      </div>

      <div class="meta-grid" id="meta-grid" style="display: none;">
        <div class="meta-item">
          <div class="label">Provider</div>
          <div class="value" id="meta-provider">-</div>
        </div>
        <div class="meta-item">
          <div class="label">Duration</div>
          <div class="value" id="meta-duration">-</div>
        </div>
        <div class="meta-item">
          <div class="label">Tokens Used</div>
          <div class="value" id="meta-tokens">-</div>
        </div>
        <div class="meta-item">
          <div class="label">Credits Left</div>
          <div class="value credits" id="meta-credits">-</div>
        </div>
      </div>

      <div style="margin-top: 20px;">
        <h3>Compare: Without Idea</h3>
        <button class="secondary" id="compare-btn" onclick="generateWithoutIdea()">
          Generate Without Idea
        </button>
        <div id="compare-box" class="response-box" style="margin-top: 10px; display: none;"></div>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const providerSelect = document.getElementById('provider-select');
    const modelSelect = document.getElementById('model-select');
    const priceDisplay = document.getElementById('price-display');
    const userIdInput = document.getElementById('user-id');
    const messagesContainer = document.getElementById('messages-container');
    const replyMessage = document.getElementById('reply-message');
    const ideaInput = document.getElementById('idea-input');
    const generateBtn = document.getElementById('generate-btn');
    const responseBox = document.getElementById('response-box');
    const metaGrid = document.getElementById('meta-grid');
    const compareBtn = document.getElementById('compare-btn');
    const compareBox = document.getElementById('compare-box');

    // State
    let providersData = [];

    // ============ Initialize ============

    async function init() {
      await loadModels();
      await loadCurrentConfig();
      addMessage(false, "Hey! How's your day going?");
      addMessage(true, "Pretty good! Just got back from a hike");
      addMessage(false, "Oh nice! I love hiking too. Where did you go?");
      replyMessage.value = "Oh nice! I love hiking too. Where did you go?";
      ideaInput.value = "mention a specific trail and suggest we go together sometime";
    }

    async function loadModels() {
      try {
        const res = await fetch('/api/models');
        providersData = await res.json();
        populateProviders();
      } catch (err) {
        console.error('Failed to load models:', err);
      }
    }

    async function loadCurrentConfig() {
      try {
        const [providerRes, modelRes] = await Promise.all([
          fetch('/api/llm-provider'),
          fetch('/api/llm-model')
        ]);
        const providerData = await providerRes.json();
        const modelData = await modelRes.json();

        providerSelect.value = providerData.provider || 'openai';
        populateModels();
        modelSelect.value = modelData.modelName || 'gpt-4o';
        updatePrice();
      } catch (err) {
        console.error('Failed to load config:', err);
      }
    }

    function populateProviders() {
      providerSelect.innerHTML = '';
      providersData.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        providerSelect.appendChild(opt);
      });
    }

    function populateModels() {
      const provider = providersData.find(p => p.id === providerSelect.value);
      modelSelect.innerHTML = '';
      if (provider) {
        provider.models.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.id;
          modelSelect.appendChild(opt);
        });
      }
      updatePrice();
    }

    function updatePrice() {
      const provider = providersData.find(p => p.id === providerSelect.value);
      const model = provider?.models.find(m => m.id === modelSelect.value);
      priceDisplay.textContent = model?.input_price ? `$${model.input_price}` : '-';
    }

    providerSelect.addEventListener('change', populateModels);
    modelSelect.addEventListener('change', updatePrice);

    // ============ Messages ============

    function addMessage(isFromMe = false, text = '') {
      const div = document.createElement('div');
      div.className = 'message-item';
      div.innerHTML = `
        <select onchange="updateMessageSender(this)">
          <option value="false" ${!isFromMe ? 'selected' : ''}>Her</option>
          <option value="true" ${isFromMe ? 'selected' : ''}>You</option>
        </select>
        <input type="text" value="${escapeHtml(text)}" placeholder="Message text...">
        <button onclick="removeMessage(this)">X</button>
      `;
      messagesContainer.appendChild(div);
    }

    function removeMessage(btn) {
      btn.closest('.message-item').remove();
    }

    function getContext() {
      const items = messagesContainer.querySelectorAll('.message-item');
      return Array.from(items).map(item => ({
        is_from_me: item.querySelector('select').value === 'true',
        text: item.querySelector('input').value
      })).filter(m => m.text.trim());
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============ Generate ============

    async function generateResponse() {
      const context = getContext();
      const message = replyMessage.value.trim();
      const idea = ideaInput.value.trim();

      if (!message) {
        alert('Please enter a message to reply to');
        return;
      }

      if (!idea) {
        alert('Please enter an idea to incorporate');
        return;
      }

      generateBtn.disabled = true;
      generateBtn.innerHTML = '<span class="loading"></span>Generating...';
      responseBox.textContent = 'Generating response...';
      responseBox.className = 'response-box';
      metaGrid.style.display = 'none';

      try {
        const body = {
          context,
          message,
          spec: { idea }
        };

        const userId = userIdInput.value.trim();
        if (userId) body.userId = userId;

        const res = await fetch('/api/generate-response-with-idea', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();

        if (data.error) {
          responseBox.textContent = 'Error: ' + data.error;
          responseBox.className = 'response-box error';
        } else {
          responseBox.textContent = data.response;
          responseBox.className = 'response-box success';

          // Show metadata
          metaGrid.style.display = 'grid';
          document.getElementById('meta-provider').textContent = data.provider || '-';
          document.getElementById('meta-duration').textContent = data.timing?.totalDurationSeconds ? `${data.timing.totalDurationSeconds}s` : '-';
          document.getElementById('meta-tokens').textContent = data.usage?.totalTokens || '-';
          document.getElementById('meta-credits').textContent = data.creditsRemaining !== undefined ? data.creditsRemaining : '-';
        }
      } catch (err) {
        responseBox.textContent = 'Request failed: ' + err.message;
        responseBox.className = 'response-box error';
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = 'Generate Response';
      }
    }

    async function generateWithoutIdea() {
      const context = getContext();
      const message = replyMessage.value.trim();

      if (!message) {
        alert('Please enter a message to reply to');
        return;
      }

      compareBtn.disabled = true;
      compareBtn.innerHTML = '<span class="loading"></span>Generating...';
      compareBox.style.display = 'block';
      compareBox.textContent = 'Generating response without idea...';
      compareBox.className = 'response-box';

      try {
        const body = { context, message, spec: {} };
        const userId = userIdInput.value.trim();
        if (userId) body.userId = userId;

        const res = await fetch('/api/generate-response', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();

        if (data.error) {
          compareBox.textContent = 'Error: ' + data.error;
          compareBox.className = 'response-box error';
        } else {
          compareBox.textContent = data.response;
          compareBox.className = 'response-box success';
        }
      } catch (err) {
        compareBox.textContent = 'Request failed: ' + err.message;
        compareBox.className = 'response-box error';
      } finally {
        compareBtn.disabled = false;
        compareBtn.innerHTML = 'Generate Without Idea';
      }
    }

    // ============ Utilities ============

    function loadSampleData() {
      messagesContainer.innerHTML = '';
      addMessage(false, "Hey! How's your day going?");
      addMessage(true, "Pretty good! Just finished work. You?");
      addMessage(false, "Same here! Finally Friday. Any plans for the weekend?");
      replyMessage.value = "Same here! Finally Friday. Any plans for the weekend?";
      ideaInput.value = "suggest getting coffee together on Saturday";
    }

    function clearAll() {
      messagesContainer.innerHTML = '';
      replyMessage.value = '';
      ideaInput.value = '';
      responseBox.textContent = 'Response will appear here...';
      responseBox.className = 'response-box';
      compareBox.style.display = 'none';
      metaGrid.style.display = 'none';
    }

    // Initialize
    init();
  </script>
</body>
</html>
